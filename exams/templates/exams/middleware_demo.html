{% extends 'exams/base.html' %}

{% block title %}DÃ©monstration des Middlewares{% endblock %}

{% block content %}
<h1 style="color: #667eea; margin-bottom: 30px;">ğŸ”§ DÃ©monstration des Middlewares Django</h1>

<div class="card" style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);">
    <h2 style="margin-bottom: 20px;">ğŸ›¡ï¸ Middlewares actifs sur cette application</h2>
    <div style="display: grid; gap: 15px;">
        <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745;">
            <h4 style="color: #28a745; margin-bottom: 10px;">âœ… SessionMiddleware</h4>
            <p style="color: #666; line-height: 1.6;">GÃ¨re automatiquement vos sessions utilisateur. Votre session est sauvegardÃ©e automatiquement sans code supplÃ©mentaire.</p>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745;">
            <h4 style="color: #28a745; margin-bottom: 10px;">âœ… AuthenticationMiddleware</h4>
            <p style="color: #666; line-height: 1.6;">Associe automatiquement chaque requÃªte Ã  l'utilisateur connectÃ©. AccÃ¨s via <code>request.user</code></p>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745;">
            <h4 style="color: #28a745; margin-bottom: 10px;">âœ… CsrfViewMiddleware</h4>
            <p style="color: #666; line-height: 1.6;">Protection automatique contre les attaques CSRF. Chaque formulaire est protÃ©gÃ© avec un token unique.</p>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea;">
            <h4 style="color: #667eea; margin-bottom: 10px;">ğŸ”§ LoggingMiddleware (PersonnalisÃ©)</h4>
            <p style="color: #666; line-height: 1.6;">Enregistre automatiquement toutes les requÃªtes HTTP avec l'utilisateur, l'heure et la durÃ©e.</p>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea;">
            <h4 style="color: #667eea; margin-bottom: 10px;">ğŸ”§ SessionSecurityMiddleware (PersonnalisÃ©)</h4>
            <p style="color: #666; line-height: 1.6;">Renforce la sÃ©curitÃ© des sessions : dÃ©tection d'inactivitÃ©, validation d'IP, rotation de clÃ©s.</p>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea;">
            <h4 style="color: #667eea; margin-bottom: 10px;">ğŸ”§ ErrorHandlingMiddleware (PersonnalisÃ©)</h4>
            <p style="color: #666; line-height: 1.6;">GÃ¨re les erreurs de maniÃ¨re centralisÃ©e et affiche des pages d'erreur personnalisÃ©es.</p>
        </div>
    </div>
</div>

<div class="card">
    <h2 style="margin-bottom: 20px;">ğŸ“Š Informations de votre session actuelle</h2>
    <table>
        <tr>
            <th>PropriÃ©tÃ©</th>
            <th>Valeur</th>
        </tr>
        <tr>
            <td><strong>Session Key</strong></td>
            <td><code>{{ session_info.session_key }}</code></td>
        </tr>
        <tr>
            <td><strong>DerniÃ¨re activitÃ©</strong></td>
            <td>{{ session_info.last_activity|default:"Non enregistrÃ©e" }}</td>
        </tr>
        <tr>
            <td><strong>Adresse IP</strong></td>
            <td><code>{{ session_info.session_ip|default:"Non enregistrÃ©e" }}</code></td>
        </tr>
        <tr>
            <td><strong>Examen en cours</strong></td>
            <td>
                {% if session_info.exam_in_progress %}
                    <span class="badge badge-warning">âœï¸ Oui</span>
                {% else %}
                    <span class="badge badge-success">âœ… Non</span>
                {% endif %}
            </td>
        </tr>
        <tr>
            <td><strong>Utilisateur</strong></td>
            <td><strong>{{ user.username }}</strong></td>
        </tr>
        <tr>
            <td><strong>AuthentifiÃ©</strong></td>
            <td><span class="badge badge-success">âœ… Oui</span></td>
        </tr>
    </table>
</div>

<div class="card">
    <h2 style="margin-bottom: 20px;">ğŸ’¡ Comparaison : Sans vs Avec Middlewares</h2>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
        <div>
            <h3 style="color: #dc3545; margin-bottom: 15px;">âŒ Sans Middlewares</h3>
            <div style="background: #f8d7da; padding: 20px; border-radius: 8px; height: 100%;">
                <pre style="margin: 0; font-size: 13px; line-height: 1.8; color: #721c24; white-space: pre-wrap;">
def my_view(request):
    # VÃ©rifier l'authentification
    if not request.user.is_authenticated:
        return redirect('login')
    
    # Logger la requÃªte
    logger.info(f"{request.user} - {request.path}")
    
    # VÃ©rifier CSRF manuellement
    if request.method == 'POST':
        csrf_token = request.POST.get('csrf')
        if not verify_csrf(csrf_token):
            return HttpResponse('CSRF Error', status=403)
    
    # GÃ©rer les erreurs
    try:
        # Logique mÃ©tier
        pass
    except Exception as e:
        logger.error(str(e))
        return render('error.html')
    
    # Mettre Ã  jour la session
    request.session['last_activity'] = now()
    request.session.save()
    
    return render(request, 'template.html')
                </pre>
            </div>
        </div>
        
        <div>
            <h3 style="color: #28a745; margin-bottom: 15px;">âœ… Avec Middlewares Django</h3>
            <div style="background: #d4edda; padding: 20px; border-radius: 8px; height: 100%;">
                <pre style="margin: 0; font-size: 13px; line-height: 1.8; color: #155724; white-space: pre-wrap;">
@login_required  # Authentification automatique
def my_view(request):
    # Tout est gÃ©rÃ© automatiquement par les middlewares :
    # âœ… Authentification
    # âœ… CSRF protection
    # âœ… Logging des requÃªtes
    # âœ… Gestion des sessions
    # âœ… Gestion des erreurs
    
    # Vous Ã©crivez seulement la logique mÃ©tier
    return render(request, 'template.html')
                </pre>
                <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px; border-left: 4px solid #28a745;">
                    <strong style="color: #28a745;">Ã‰conomie :</strong>
                    <ul style="margin: 10px 0 0 20px; color: #155724;">
                        <li>90% moins de code</li>
                        <li>0 duplication</li>
                        <li>SÃ©curitÃ© garantie</li>
                        <li>Maintenance facile</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card" style="background: #e3f2fd;">
    <h2 style="margin-bottom: 20px; color: #1976d2;">ğŸ“ Fichier django.log (Logs en temps rÃ©el)</h2>
    <p style="color: #666; margin-bottom: 15px;">
        Toutes les requÃªtes sont automatiquement enregistrÃ©es dans le fichier <code>django.log</code> 
        grÃ¢ce au middleware de logging personnalisÃ©.
    </p>
    <div style="background: #1e1e1e; padding: 20px; border-radius: 8px; color: #00ff00; font-family: monospace; font-size: 13px; overflow-x: auto;">
        <div>[INFO] 2025-10-21 12:30:45 middleware â¡ï¸ GET /exams/ | User: {{ user.username }}</div>
        <div>[INFO] 2025-10-21 12:30:45 middleware â¬…ï¸ Status 200 | DurÃ©e: 0.045s</div>
        <div>[INFO] 2025-10-21 12:31:12 middleware â¡ï¸ POST /exam/1/start/ | User: {{ user.username }}</div>
        <div>[INFO] 2025-10-21 12:31:12 middleware â¬…ï¸ Status 302 | DurÃ©e: 0.089s</div>
        <div>[INFO] 2025-10-21 12:35:20 middleware â¡ï¸ POST /exam/1/take/ | User: {{ user.username }}</div>
        <div>[INFO] 2025-10-21 12:35:21 middleware â¬…ï¸ Status 302 | DurÃ©e: 0.234s</div>
    </div>
</div>

<div class="card">
    <h2 style="margin-bottom: 20px;">ğŸ” DÃ©monstration de la protection CSRF</h2>
    <p style="color: #666; margin-bottom: 20px;">
        Chaque formulaire de cette application est automatiquement protÃ©gÃ© par un token CSRF unique 
        gÃ©nÃ©rÃ© par le middleware <code>CsrfViewMiddleware</code>.
    </p>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
            <h4 style="margin-bottom: 10px;">Sans CSRF Token âŒ</h4>
            <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border-left: 4px solid #dc3545;">
                <code style="color: #721c24;">&lt;form method="post"&gt;<br>&nbsp;&nbsp;...<br>&lt;/form&gt;</code>
                <p style="margin-top: 10px; color: #721c24; font-size: 14px;">
                    âš ï¸ VulnÃ©rable aux attaques CSRF
                </p>
            </div>
        </div>
        
        <div>
            <h4 style="margin-bottom: 10px;">Avec CSRF Token âœ…</h4>
            <div style="background: #d4edda; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                <code style="color: #155724;">&lt;form method="post"&gt;<br>&nbsp;&nbsp;{% verbatim %}{% csrf_token %}{% endverbatim %}<br>&nbsp;&nbsp;...<br>&lt;/form&gt;</code>
                <p style="margin-top: 10px; color: #155724; font-size: 14px;">
                    âœ… ProtÃ©gÃ© automatiquement
                </p>
            </div>
        </div>
    </div>
</div>

<div class="card" style="background: linear-gradient(135deg, #28a74515 0%, #20c99715 100%);">
    <h2 style="margin-bottom: 20px; color: #28a745;">âœ¨ Avantages des Middlewares</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
        <div style="background: white; padding: 20px; border-radius: 8px;">
            <div style="font-size: 36px; margin-bottom: 10px;">ğŸ¯</div>
            <h4 style="color: #333; margin-bottom: 10px;">Centralisation</h4>
            <p style="color: #666; font-size: 14px;">Toute la logique de sÃ©curitÃ© et de gestion est centralisÃ©e en un seul endroit</p>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 8px;">
            <div style="font-size: 36px; margin-bottom: 10px;">â™»ï¸</div>
            <h4 style="color: #333; margin-bottom: 10px;">RÃ©utilisabilitÃ©</h4>
            <p style="color: #666; font-size: 14px;">Un middleware s'applique automatiquement Ã  toutes les vues</p>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 8px;">
            <div style="font-size: 36px; margin-bottom: 10px;">ğŸ›¡ï¸</div>
            <h4 style="color: #333; margin-bottom: 10px;">SÃ©curitÃ©</h4>
            <p style="color: #666; font-size: 14px;">Protection automatique contre les vulnÃ©rabilitÃ©s courantes</p>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 8px;">
            <div style="font-size: 36px; margin-bottom: 10px;">âš¡</div>
            <h4 style="color: #333; margin-bottom: 10px;">Performance</h4>
            <p style="color: #666; font-size: 14px;">Optimisation automatique des requÃªtes et du cache</p>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 8px;">
            <div style="font-size: 36px; margin-bottom: 10px;">ğŸ§¹</div>
            <h4 style="color: #333; margin-bottom: 10px;">Code propre</h4>
            <p style="color: #666; font-size: 14px;">Moins de duplication, code plus maintenable</p>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 8px;">
            <div style="font-size: 36px; margin-bottom: 10px;">ğŸ“Š</div>
            <h4 style="color: #333; margin-bottom: 10px;">Monitoring</h4>
            <p style="color: #666; font-size: 14px;">Logs et statistiques automatiques sur toutes les requÃªtes</p>
        </div>
    </div>
</div>
{% endblock %}